<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unidades</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style> body { font-family: 'Inter', sans-serif; } </style>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg-[#faf7f2]">
<div class="flex h-screen w-full overflow-hidden">
  <aside class="w-20 bg-brand-800 text-white flex flex-col py-8 space-y-8 items-center rounded-r-3xl shadow-xl">
    <div class="text-xl font-bold rotate-[-90deg] tracking-wide">MAESTRO</div>
    <nav class="flex flex-col space-y-6 text-white opacity-90 text-2xl">
      <a href="index.html"><i class="fa-solid fa-home cursor-pointer hover:opacity-100"></i></a>
      <a href="alumnos.html"><i class="fa-solid fa-users cursor-pointer hover:opacity-100"></i></a>
      <a href="unidades.html"><i class="fa-solid fa-book cursor-pointer hover:opacity-100"></i></a>
      <a href="equipos.html"><i class="fa-solid fa-people-group cursor-pointer hover:opacity-100"></i></a>
      <a href="tareas.html"><i class="fa-solid fa-list-check cursor-pointer hover:opacity-100"></i></a>
      <a href="reportes.html"><i class="fa-solid fa-chart-simple cursor-pointer hover:opacity-100"></i></a>
    </nav>
  </aside>

  <main class="flex-1 p-10">
    <h1 class="text-3xl font-semibold mb-6 text-brand-800">Unidades</h1>
    <div class="bg-white rounded-3xl shadow-xl p-8 w-full border border-gray-100">
      <div class="flex gap-8 mb-6 text-lg">
        <a href="index.html" class="text-gray-400 hover:text-gray-600">Grupos</a>
        <a href="alumnos.html" class="text-gray-400 hover:text-gray-600">Alumnos</a>
        <span class="font-semibold text-brand-700 border-b-2 border-brand-700 pb-1">Unidades</span>
      </div>

      <div class="flex justify-between items-center mb-6">
        <div id="grupo-info" class="flex items-center gap-4"></div>

        <button class="btn bg-brand-600 hover:bg-brand-700 text-white px-6 rounded-xl shadow-md" onclick="mostrarModalNuevoUnidad()">+ Agregar Unidad</button>
      </div>

      <div id="lista-unidades" class="space-y-3">
        <!-- Unidades se insertan aquí -->
      </div>
    </div>
  </main>
</div>

<!-- Modal nueva unidad -->
<input type="checkbox" id="modal-unidad" class="modal-toggle" />
<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-xl mb-4">Agregar Unidad</h3>
    <input id="nuevo_numero" type="number" placeholder="Número de unidad" class="input input-bordered w-full mb-3" />
    <input id="nuevo_descripcion" type="text" placeholder="Descripción" class="input input-bordered w-full mb-3" />
    <input type="hidden" id="unidad-edit-id" />
    <div class="modal-action">
      <label for="modal-unidad" class="btn">Cancelar</label>
      <button onclick="guardarUnidad()" class="btn bg-brand-600 text-white">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal confirmar eliminar unidad -->
<input type="checkbox" id="modal-eliminar-unidad" class="modal-toggle" />
<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Confirmar eliminación</h3>
    <p class="py-4">¿Deseas eliminar esta unidad?</p>
    <div class="modal-action">
      <label for="modal-eliminar-unidad" class="btn">Cancelar</label>
      <button id="btn-confirmar-eliminar-unidad" class="btn btn-error text-white">Eliminar</button>
    </div>
  </div>
</div>

<!-- FontAwesome -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<script>
window.onload = function(){
  const params = new URLSearchParams(window.location.search);
  const grupoParam = params.get('grupo');
  let selected = localStorage.getItem('selectedGrupo') || grupoParam;
  if (grupoParam && grupoParam !== localStorage.getItem('selectedGrupo')){
    localStorage.setItem('selectedGrupo', grupoParam);
    selected = grupoParam;
  }
  if(!selected){ window.location.href = 'index.html'; return; }

  // mostrar info del grupo
  fetch(`/api/grupos/${selected}`).then(r=>r.json()).then(g=>{
    const info = document.getElementById('grupo-info');
    info.innerHTML = `<div class="font-semibold">${g.numero} - ${g.materia}</div><button class="btn btn-sm btn-ghost" id="btn-cambiar-grupo">Cambiar Grupo</button>`;
    document.getElementById('btn-cambiar-grupo').onclick = ()=>{ localStorage.removeItem('selectedGrupo'); window.location.href='index.html'; };
  });

  cargarUnidades(selected);
};

function cargarUnidades(id){
  fetch(`/api/unidades/${id}`).then(r=>r.json()).then(data=>{
    const cont = document.getElementById('lista-unidades'); cont.innerHTML = '';
    data.forEach(u=>{
      cont.innerHTML += `
        <div class="p-4 border rounded-lg bg-gray-50 flex justify-between items-center">
          <div>
            <div class="font-semibold">Unidad ${u.numero_unidad}</div>
            <div class="text-sm text-gray-600">${u.descripcion ?? ''}</div>
          </div>
          <div class="space-x-2">
            <button class="btn btn-sm" onclick="abrirEditarUnidad(${u.id_unidad}, ${u.numero_unidad}, '${(u.descripcion||'').replace(/'/g,"\'")}')">Editar</button>
            <button class="btn btn-sm btn-error text-white" onclick="eliminarUnidad(${u.id_unidad})">X</button>
            <a class="btn btn-sm" href="equipos.html?unidad=${u.id_unidad}">Ver Equipos</a>
          </div>
        </div>
      `;
    });
  });
}

function mostrarModalNuevoUnidad(){
  document.getElementById('unidad-edit-id').value = '';
  document.getElementById('nuevo_numero').value = '';
  document.getElementById('nuevo_descripcion').value = '';
  document.getElementById('modal-unidad').checked = true;
}

function guardarUnidad(){
  const numero = parseInt(document.getElementById('nuevo_numero').value);
  const descripcion = document.getElementById('nuevo_descripcion').value;
  const id_grupo = localStorage.getItem('selectedGrupo');
  const editId = document.getElementById('unidad-edit-id').value;
  if(editId){
    fetch(`/api/unidades/${editId}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({numero_unidad: numero, descripcion})}).then(()=>{ document.getElementById('modal-unidad').checked = false; cargarUnidades(id_grupo); });
  } else {
    fetch('/api/unidades', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({numero_unidad: numero, descripcion, id_grupo})})
      .then(()=>{ document.getElementById('modal-unidad').checked = false; cargarUnidades(id_grupo); });
  }
}

function abrirEditarUnidad(id, num, desc){
  document.getElementById('unidad-edit-id').value = id;
  document.getElementById('nuevo_numero').value = num;
  document.getElementById('nuevo_descripcion').value = desc || '';
  document.getElementById('modal-unidad').checked = true;
}

function eliminarUnidad(id){
  document.getElementById('modal-eliminar-unidad').checked = true;
  const btn = document.getElementById('btn-confirmar-eliminar-unidad');
  btn.onclick = function(){
    fetch(`/api/unidades/${id}`,{method:'DELETE'}).then(()=>{ document.getElementById('modal-eliminar-unidad').checked = false; cargarUnidades(localStorage.getItem('selectedGrupo')); });
  };
}

</script>
</body>
</html>
