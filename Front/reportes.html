<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reportes</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style> body { font-family: 'Inter', sans-serif; } </style>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg-[#faf7f2]">
<div class="flex h-screen w-full overflow-hidden">
  <aside class="w-20 bg-brand-800 text-white flex flex-col py-8 space-y-8 items-center rounded-r-3xl shadow-xl">
    <div class="text-xl font-bold rotate-[-90deg] tracking-wide">MAESTRO</div>
    <nav class="flex flex-col space-y-6 text-white opacity-90 text-2xl">
      <a href="index.html"><i class="fa-solid fa-home cursor-pointer hover:opacity-100"></i></a>
      <a href="alumnos.html"><i class="fa-solid fa-users cursor-pointer hover:opacity-100"></i></a>
      <a href="unidades.html"><i class="fa-solid fa-book cursor-pointer hover:opacity-100"></i></a>
      <a href="equipos.html"><i class="fa-solid fa-people-group cursor-pointer hover:opacity-100"></i></a>
      <a href="reportes.html"><i class="fa-solid fa-chart-simple cursor-pointer hover:opacity-100"></i></a>
      <a href="tareas.html"><i class="fa-solid fa-list-check cursor-pointer hover:opacity-100"></i></a>
    </nav>
  </aside>

  <main class="flex-1 p-10">
    <h1 class="text-3xl font-semibold mb-6 text-brand-800">Reportes</h1>
    <div class="bg-white rounded-3xl shadow-xl p-8 w-full border border-gray-100">
      <!-- TABS (normalizado) -->
      <div id="main-tabs" class="flex gap-6 mb-6 text-lg">
        <a href="index.html" data-page="index" class="tab-link text-gray-400 hover:text-gray-600">Grupos</a>
        <a href="alumnos.html" data-page="alumnos" class="tab-link text-gray-400 hover:text-gray-600">Alumnos</a>
        <a href="unidades.html" data-page="unidades" class="tab-link text-gray-400 hover:text-gray-600">Unidades</a>
        <a href="equipos.html" data-page="equipos" class="tab-link text-gray-400 hover:text-gray-600">Equipos</a>
        <a href="tareas.html" data-page="tareas" class="tab-link text-gray-400 hover:text-gray-600">Tareas</a>
        <a href="Calificar.html" data-page="calificar" class="tab-link text-gray-400 hover:text-gray-600">Calificar</a>
        <a href="reportes.html" data-page="reportes" class="tab-link text-gray-400 hover:text-gray-600">Reportes</a>
      </div>
      <script>
        (function(){
          const path = window.location.pathname.split('/').pop() || 'index.html';
          const page = (path.replace('.html','') || 'index').toLowerCase();
          document.querySelectorAll('#main-tabs .tab-link').forEach(a=>{
            if(a.dataset.page===page){
              a.classList.remove('text-gray-400');
              a.classList.add('font-semibold','text-brand-700','border-b-2','border-brand-700','pb-1');
            }
          });
        })();
      </script>

      <div id="contenedor-reportes">
        <p class="text-gray-600">Cargando calificaciones...</p>
      </div>
    </div>
  </main>
</div>

<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script>
let selectedGrupo = null;
window.onload = ()=>{
  const params = new URLSearchParams(window.location.search);
  const grupoParam = params.get('grupo');
  if (grupoParam) { localStorage.setItem('selectedGrupo', grupoParam); }
  selectedGrupo = localStorage.getItem('selectedGrupo') || null;
  // If user opens report views that require a group, redirect to index to select
  // We'll allow the generic 'grupo' report to show all groups even without selection
  // Mostrar automáticamente calificaciones por unidad/equipo si hay grupo seleccionado
  if(selectedGrupo){ mostrarCalificacionesEquiposUnidades(); } else { document.getElementById('contenedor-reportes').innerHTML = '<p class="text-gray-600">Selecciona un grupo en la página principal para ver los reportes.</p>'; }
};

function mostrarReporte(tipo){
  const cont = document.getElementById('contenedor-reportes'); cont.innerHTML = '';
  if(tipo==='alumno'){
    cont.innerHTML = `
      <div class="flex gap-3 mb-4">
        <div id="rep-grupo" class="font-semibold"></div>
        <select id="rep-unidad" class="select select-bordered w-64"><option disabled selected>Unidad</option></select>
        <select id="rep-alumno" class="select select-bordered w-64"><option disabled selected>Alumno</option></select>
        <button class="btn" onclick="verReporteAlumno()">Ver</button>
      </div>
      <div id="rep-alumno-resultado"></div>
    `;
    cargarGruposRep();
  }
  if(tipo==='equipo'){
    cont.innerHTML = `
      <div class="flex gap-3 mb-4">
        <div id="rep-grupo-e" class="font-semibold"></div>
        <select id="rep-unidad-e" class="select select-bordered w-64"><option disabled selected>Unidad</option></select>
        <select id="rep-equipo" class="select select-bordered w-64"><option disabled selected>Equipo</option></select>
        <button class="btn" onclick="verReporteEquipo()">Ver</button>
      </div>
      <div id="rep-equipo-resultado"></div>
    `;
    cargarGruposRep('e');
  }
  if(tipo==='unidad'){
    cont.innerHTML = `
      <div class="flex gap-3 mb-4">
        <div id="rep-grupo-u" class="font-semibold"></div>
        <select id="rep-unidad-u" class="select select-bordered w-64"><option disabled selected>Unidad</option></select>
        <button class="btn" onclick="verReporteUnidad()">Ver</button>
      </div>
      <div id="rep-unidad-resultado"></div>
    `;
    cargarGruposRep('u');
  }
  if(tipo==='grupo'){
    cont.innerHTML = `<div id="rep-grupo-resultado"></div>`; fetch('/api/grupos').then(r=>r.json()).then(gs=>{ let html='<h3 class="font-semibold">Grupos</h3>'; gs.forEach(g=> html+=`<div class="p-3 border rounded mt-2">${g.numero} - ${g.materia} <a class="btn btn-sm ml-4" href="alumnos.html?grupo=${g.id_grupo}">Ver Alumnos</a></div>`); document.getElementById('rep-grupo-resultado').innerHTML = html; });
  }
}

function cargarGruposRep(suffix){
  // Si hay grupo persistente, usarlo
  if(selectedGrupo){
    // mostrar nombre en the container (we used divs instead of selects)
    fetch(`/api/grupos/${selectedGrupo}`).then(r=>r.json()).then(g=>{
      const selDiv = document.getElementById(suffix?`rep-grupo-${suffix}`:`rep-grupo`);
      if(!selDiv) return;
      selDiv.innerHTML = `${g.numero} - ${g.materia} <button class="btn btn-sm btn-ghost" id="btn-cambiar-grupo">Cambiar</button>`;
      document.getElementById('btn-cambiar-grupo').onclick = ()=>{ localStorage.removeItem('selectedGrupo'); window.location.href='index.html'; };
      // cargar unidades para ese grupo
      cargarUnidadesRep(selectedGrupo, suffix);
    });
    return;
  }
  // si no hay persistente, cargar todos
  fetch('/api/grupos').then(r=>r.json()).then(gs=>{ const sel = document.getElementById(suffix?`rep-grupo-${suffix}`:`rep-grupo`); if(!sel) return; gs.forEach(g=> sel.innerHTML += `<option value="${g.id_grupo}">${g.numero} - ${g.materia}</option>`); sel.addEventListener('change', ()=>cargarUnidadesRep(sel.value, suffix)); });
}

function cargarUnidadesRep(id_grupo, suffix){ fetch(`/api/unidades/${id_grupo}`).then(r=>r.json()).then(unis=>{ const sel = document.getElementById(suffix?`rep-unidad-${suffix}`:`rep-unidad`); if(!sel) return; sel.innerHTML = '<option disabled selected>Unidad</option>'; unis.forEach(u=> sel.innerHTML += `<option value="${u.id_unidad}">Unidad ${u.numero_unidad}</option>`); if(suffix==='e') sel.addEventListener('change', ()=>cargarEquiposRep(sel.value)); if(!suffix) sel.addEventListener('change', ()=>cargarAlumnosRep(id_grupo, sel.value)); if(suffix==='u') sel.addEventListener('change', ()=>{});
}); }

function cargarAlumnosRep(id_grupo, id_unidad){ fetch(`/api/alumnos/${id_grupo}`).then(r=>r.json()).then(al=>{ const sel = document.getElementById('rep-alumno'); sel.innerHTML = '<option disabled selected>Alumno</option>'; al.forEach(a=> sel.innerHTML += `<option value="${a.id_alumno}">${a.nombre}</option>`); }); }

function cargarEquiposRep(id_unidad){ fetch(`/api/equipos/${id_unidad}`).then(r=>r.json()).then(es=>{ const sel = document.getElementById('rep-equipo'); sel.innerHTML = '<option disabled selected>Equipo</option>'; es.forEach(e=> sel.innerHTML += `<option value="${e.id_equipo}">${e.nombre_equipo}</option>`); }); }

function verReporteAlumno(){ const id_unidad = document.getElementById('rep-unidad').value; const id_alumno = document.getElementById('rep-alumno').value; if(!id_unidad||!id_alumno) return alert('Seleccione unidad y alumno'); fetch(`/api/calificacion_unidad/${id_unidad}/${id_alumno}`).then(r=>r.json()).then(res=>{ document.getElementById('rep-alumno-resultado').innerHTML = `<div class="p-4 border rounded">Calificación final: <strong>${res.calificacion_final ?? res.calificacion_final === 0 ? res.calificacion_final : (res.calificacion_final)}</strong></div>`; }); }

function verReporteEquipo(){ const id_equipo = document.getElementById('rep-equipo').value; if(!id_equipo) return; fetch(`/api/calificaciones/equipo/${id_equipo}`).then(r=>r.json()).then(data=>{ let html = '<h3 class="font-semibold">Calificaciones por tarea</h3>'; data.forEach(c=> html+=`<div class="p-2 border rounded mt-2">Tarea ${c.id_tarea}: <strong>${c.calificacion}</strong></div>`); document.getElementById('rep-equipo-resultado').innerHTML = html; }); }

function verReporteUnidad(){ const id_unidad = document.getElementById('rep-unidad-u').value; if(!id_unidad) return; fetch(`/api/calificacion_unidad/calc/${id_unidad}`,{method:'POST'}).then(r=>r.json()).then(data=>{ let html = '<h3 class="font-semibold">Calificaciones por alumno</h3>'; data.forEach(d=> html+=`<div class="p-2 border rounded mt-2">Alumno ${d.id_alumno}: <strong>${d.calificacion_final ?? 0}</strong></div>`); document.getElementById('rep-unidad-resultado').innerHTML = html; }); }

// Mostrar calificaciones finales por unidad para todos los equipos
function mostrarCalificacionesEquiposUnidades(){
  const cont = document.getElementById('contenedor-reportes');
  cont.innerHTML = '';
  const id_grupo = selectedGrupo;
  if(!id_grupo){ cont.innerHTML = '<p class="text-gray-600">No hay grupo seleccionado. Ve a la página principal y selecciona un grupo.</p>'; return; }

  // Obtener unidades del grupo
  fetch(`/api/unidades/${id_grupo}`).then(r=>r.json()).then(unidades=>{
    if(!unidades || unidades.length===0){ cont.innerHTML = '<p class="text-gray-600">No hay unidades para este grupo.</p>'; return; }

    // Construir DOM incrementalmente por unidad (no usar innerHTML completo para evitar sobrescrituras)
    unidades.forEach(u => {
      const unitWrap = document.createElement('div');
      unitWrap.className = 'mb-6';
      const h3 = document.createElement('h3'); h3.className = 'font-semibold'; h3.textContent = `Unidad ${u.numero_unidad}`;
      unitWrap.appendChild(h3);

      const info = document.createElement('div'); info.className = 'mt-2 border rounded p-2 bg-gray-50';
      const table = document.createElement('table'); table.className = 'table w-full';
      const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Equipo</th><th>Calificación final</th></tr>';
      const tbody = document.createElement('tbody'); tbody.id = `tbody-u-${u.id_unidad}`;
      table.appendChild(thead); table.appendChild(tbody); info.appendChild(table); unitWrap.appendChild(info);
      cont.appendChild(unitWrap);

      // Obtener tareas (pesos)
      fetch(`/api/tareas/${u.id_unidad}`).then(r=>r.json()).then(tareas=>{
        const valorMap = {};
        if(tareas && tareas.length) tareas.forEach(t=> valorMap[t.id_tarea] = parseFloat(t.valor)||0);

        // Obtener equipos
        fetch(`/api/equipos/${u.id_unidad}`).then(r=>r.json()).then(equipos=>{
          if(!equipos || equipos.length===0){
            const tr = document.createElement('tr'); tr.innerHTML = '<td colspan="2" class="text-sm text-gray-500">No hay equipos</td>'; tbody.appendChild(tr);
            return;
          }

          // Para cada equipo obtener calificaciones
          equipos.forEach(equipo => {
            const row = document.createElement('tr');
            const tdName = document.createElement('td'); tdName.textContent = equipo.nombre_equipo;
            const tdVal = document.createElement('td'); tdVal.textContent = 'Calculando...';
            row.appendChild(tdName); row.appendChild(tdVal); tbody.appendChild(row);

            fetch(`/api/calificaciones/equipo/${equipo.id_equipo}`).then(r=>r.json()).then(califs=>{
              try{
                if(!califs || califs.length===0){ tdVal.textContent = 'Sin calificaciones'; return; }
                let suma = 0; let pesoTotal = 0; const vals = [];
                califs.forEach(c=>{
                  const peso = valorMap[c.id_tarea] ?? 0;
                  // aplicar peso como porcentaje (valor/100)
                  const factor = (parseFloat(peso)||0) / 100.0;
                  suma += (parseFloat(c.calificacion)||0) * factor;
                  pesoTotal += factor;
                  vals.push(parseFloat(c.calificacion)||0);
                });
                let final = 0;
                if(pesoTotal>0) final = suma; else final = vals.reduce((a,b)=>a+b,0) / (vals.length||1);
                tdVal.innerHTML = `<strong>${final.toFixed(2)}</strong>`;
              }catch(err){ console.error(err); tdVal.innerHTML = '<span class="text-red-500">Error</span>'; }
            }).catch(err=>{ console.error(err); tdVal.innerHTML = '<span class="text-red-500">Error</span>'; });
          });
        }).catch(err=>{ console.error(err); const tr = document.createElement('tr'); tr.innerHTML = '<td colspan="2" class="text-red-500">Error cargando equipos</td>'; tbody.appendChild(tr); });
      }).catch(err=>{ console.error(err); const tr = document.createElement('tr'); tr.innerHTML = '<td colspan="2" class="text-red-500">Error cargando tareas</td>'; tbody.appendChild(tr); });
    });
  }).catch(err=>{ console.error(err); cont.innerHTML = '<p class="text-red-500">Error cargando unidades</p>'; });
}

</script>
</body>
</html>
