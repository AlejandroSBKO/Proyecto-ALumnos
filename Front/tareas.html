<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tareas</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style> body { font-family: 'Inter', sans-serif; } </style>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg-[#faf7f2]">
<div class="flex h-screen w-full overflow-hidden">
  <aside class="w-20 bg-brand-800 text-white flex flex-col py-8 space-y-8 items-center rounded-r-3xl shadow-xl">
    <div class="text-xl font-bold rotate-[-90deg] tracking-wide">MAESTRO</div>
    <nav class="flex flex-col space-y-6 text-white opacity-90 text-2xl">
      <a href="index.html"><i class="fa-solid fa-home cursor-pointer hover:opacity-100"></i></a>
      <a href="alumnos.html"><i class="fa-solid fa-users cursor-pointer hover:opacity-100"></i></a>
      <a href="unidades.html"><i class="fa-solid fa-book cursor-pointer hover:opacity-100"></i></a>
      <a href="equipos.html"><i class="fa-solid fa-people-group cursor-pointer hover:opacity-100"></i></a>
      <a href="tareas.html"><i class="fa-solid fa-list-check cursor-pointer hover:opacity-100"></i></a>
      <a href="reportes.html"><i class="fa-solid fa-chart-simple cursor-pointer hover:opacity-100"></i></a>
    </nav>
  </aside>

  <main class="flex-1 p-10">
    <h1 class="text-3xl font-semibold mb-6 text-brand-800">Tareas</h1>
    <div class="bg-white rounded-3xl shadow-xl p-8 w-full border border-gray-100">
      <div class="flex gap-8 mb-6 text-lg">
        <a href="index.html" class="text-gray-400 hover:text-gray-600">Grupos</a>
        <a href="alumnos.html" class="text-gray-400 hover:text-gray-600">Alumnos</a>
        <a href="unidades.html" class="text-gray-400 hover:text-gray-600">Unidades</a>
        <a href="equipos.html" class="text-gray-400 hover:text-gray-600">Equipos</a>
        <span class="font-semibold text-brand-700 border-b-2 border-brand-700 pb-1">Tareas</span>
      </div>

      <div class="flex justify-between items-center mb-6">
        <div class="flex gap-3 items-center">
          <div id="grupo-info" class="font-semibold"></div>
          <select id="select-unidad" class="select select-bordered bg-white w-60">
            <option disabled selected>Selecciona una unidad</option>
          </select>
        </div>

        <button class="btn bg-brand-600 hover:bg-brand-700 text-white px-6 rounded-xl shadow-md" onclick="mostrarModalNuevaTarea()">+ Agregar Tarea</button>
      </div>

      <div id="lista-tareas" class="space-y-3"></div>
    </div>
  </main>
</div>

<!-- Modal nueva tarea -->
<input type="checkbox" id="modal-tarea" class="modal-toggle" />
<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-xl mb-4">Agregar Tarea</h3>
    <input id="nuevo_nombre_tarea" type="text" placeholder="Nombre de la tarea" class="input input-bordered w-full mb-3" />
    <input id="nuevo_valor" type="number" step="0.1" placeholder="Valor (peso)" class="input input-bordered w-full mb-3" />
    <input id="nuevo_desc_tarea" type="text" placeholder="Descripción" class="input input-bordered w-full mb-3" />
    <input type="hidden" id="tarea-edit-id" />
    <div class="modal-action">
      <label for="modal-tarea" class="btn">Cancelar</label>
      <button onclick="guardarTarea()" class="btn bg-brand-600 text-white">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal confirmar eliminar tarea -->
<input type="checkbox" id="modal-eliminar-tarea" class="modal-toggle" />
<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Confirmar eliminación</h3>
    <p class="py-4">¿Deseas eliminar esta tarea?</p>
    <div class="modal-action">
      <label for="modal-eliminar-tarea" class="btn">Cancelar</label>
      <button id="btn-confirmar-eliminar-tarea" class="btn btn-error text-white">Eliminar</button>
    </div>
  </div>
</div>

<!-- Modal asignar calificación -->
<!-- (Calificación removida: tareas sólo sirven para crear/editar/eliminar) -->

<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script>
window.onload = ()=>{
  const params = new URLSearchParams(window.location.search);
  const grupoParam = params.get('grupo');
  const unidadParam = params.get('unidad');
  let selected = localStorage.getItem('selectedGrupo') || grupoParam;
  if (grupoParam && grupoParam !== localStorage.getItem('selectedGrupo')){ localStorage.setItem('selectedGrupo', grupoParam); selected = grupoParam; }
  if(!selected){ window.location.href='index.html'; return; }

  fetch(`/api/grupos/${selected}`).then(r=>r.json()).then(g=>{
    document.getElementById('grupo-info').innerHTML = `${g.numero} - ${g.materia} <button class="btn btn-sm btn-ghost" id="btn-cambiar-grupo">Cambiar</button>`;
    document.getElementById('btn-cambiar-grupo').onclick = ()=>{ localStorage.removeItem('selectedGrupo'); window.location.href='index.html'; };
  });

  // cargar unidades
  fetch(`/api/unidades/${selected}`).then(r=>r.json()).then(data=>{
    const su = document.getElementById('select-unidad'); su.innerHTML = '<option disabled selected>Selecciona una unidad</option>';
    data.forEach(u=> su.innerHTML += `<option value="${u.id_unidad}">Unidad ${u.numero_unidad}</option>`);
    if(unidadParam) { su.value = unidadParam; cargarTareas(); }
  });

  document.getElementById('select-unidad').addEventListener('change', cargarTareas);
};

function cargarTareas(){
  const id = document.getElementById('select-unidad').value; if(!id) return;
  fetch(`/api/tareas/${id}`).then(r=>r.json()).then(data=>{
    const cont = document.getElementById('lista-tareas'); cont.innerHTML='';
    data.forEach(t=>{
      cont.innerHTML += `\
  <div class="p-4 border rounded-lg bg-gray-50 flex justify-between items-center">\
    <div>\
      <div class="font-semibold">${t.nombre_tarea} <span class="text-sm text-gray-500">(valor: ${t.valor})</span></div>\
      <div class="text-sm text-gray-600">${t.descripcion ?? ''}</div>\
    </div>\
    <div class="space-x-2">\
      <button class="btn btn-sm" onclick="abrirEditarTarea(${t.id_tarea}, '${(t.nombre_tarea||'').replace(/'/g,"\\'")}', ${t.valor}, '${(t.descripcion||'').replace(/'/g,"\\'")}')">Editar</button>\
      <button class="btn btn-sm btn-error text-white" onclick="eliminarTarea(${t.id_tarea})">X</button>\
    </div>\
  </div>\
  `;
    });
  });
}

function mostrarModalNuevaTarea(){
  document.getElementById('tarea-edit-id').value = '';
  document.getElementById('nuevo_nombre_tarea').value = '';
  document.getElementById('nuevo_valor').value = '';
  document.getElementById('nuevo_desc_tarea').value = '';
  document.getElementById('modal-tarea').checked = true;
}

function guardarTarea(){
  const nombre = document.getElementById('nuevo_nombre_tarea').value;
  const valor = parseFloat(document.getElementById('nuevo_valor').value||0);
  const desc = document.getElementById('nuevo_desc_tarea').value;
  const id_unidad = document.getElementById('select-unidad').value;
  const editId = document.getElementById('tarea-edit-id').value;

  if(!id_unidad){ alert('Selecciona una unidad antes de guardar la tarea'); return; }
  if(!nombre || nombre.trim() === ''){ alert('Ingresa el nombre de la tarea'); return; }
  if(isNaN(valor) || valor < 0){ alert('Ingresa un valor válido (número >= 0)'); return; }

  // Verificar que la suma de valores en la unidad no exceda 100
  fetch(`/api/tareas/${id_unidad}`).then(r=>r.json()).then(data=>{
    let suma = 0;
    data.forEach(t=>{ suma += parseFloat(t.valor) || 0; });
    if(editId){
      const old = data.find(x=> x.id_tarea == parseInt(editId));
      if(old) suma -= parseFloat(old.valor) || 0; // restar el valor previo de la tarea editada
    }
    const nuevaSuma = suma + valor;
    if(nuevaSuma > 100){
      alert(`No es posible guardar: la suma de valores sería ${nuevaSuma.toFixed(1)}% (máx 100%). Ajusta el valor.`);
      return;
    }

    // proceder con POST o PUT
    if(editId){
      fetch(`/api/tareas/${editId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre_tarea:nombre, valor, descripcion:desc})}).then(()=>{ document.getElementById('modal-tarea').checked=false; cargarTareas(); });
    } else {
      fetch('/api/tareas',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre_tarea:nombre,descripcion:desc,valor,id_unidad})}).then(()=>{ document.getElementById('modal-tarea').checked=false; cargarTareas(); });
    }
  }).catch(err=>{ alert('Error al validar valores: '+err); console.error(err); });
}

function abrirEditarTarea(id,nombre,valor,desc){
  document.getElementById('tarea-edit-id').value = id;
  document.getElementById('nuevo_nombre_tarea').value = nombre || '';
  document.getElementById('nuevo_valor').value = valor || '';
  document.getElementById('nuevo_desc_tarea').value = desc || '';
  document.getElementById('modal-tarea').checked = true;
}

function eliminarTarea(id){
  // abrir modal de confirmación y asignar acción
  document.getElementById('modal-eliminar-tarea').checked = true;
  const btn = document.getElementById('btn-confirmar-eliminar-tarea');
  btn.onclick = function(){
    fetch(`/api/tareas/${id}`,{method:'DELETE'}).then(()=>{
      document.getElementById('modal-eliminar-tarea').checked = false;
      cargarTareas();
    });
  };
}

// (Funcionalidad de asignar calificación eliminada en esta página)
</script>
</body>
</html>
