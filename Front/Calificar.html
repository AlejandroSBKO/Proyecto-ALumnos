<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calificar equipos</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <style> body{ font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-[#faf7f2]">
<div class="flex h-screen w-full">
  <aside class="w-20 bg-brand-800 text-white flex flex-col py-8 space-y-8 items-center rounded-r-3xl shadow-xl">
    <div class="text-xl font-bold rotate-[-90deg] tracking-wide">MAESTRO</div>
    <nav class="flex flex-col space-y-6 text-white opacity-90 text-2xl">
      <a href="index.html"><i class="fa-solid fa-home cursor-pointer hover:opacity-100"></i></a>
      <a href="alumnos.html"><i class="fa-solid fa-users cursor-pointer hover:opacity-100"></i></a>
      <a href="unidades.html"><i class="fa-solid fa-book cursor-pointer hover:opacity-100"></i></a>
      <a href="equipos.html"><i class="fa-solid fa-people-group cursor-pointer hover:opacity-100"></i></a>
      <a href="tareas.html"><i class="fa-solid fa-list-check cursor-pointer hover:opacity-100"></i></a>
      <a href="reportes.html"><i class="fa-solid fa-chart-simple cursor-pointer hover:opacity-100"></i></a>
    </nav>
  </aside>

  <main class="flex-1 p-10 overflow-auto">
    <h1 class="text-3xl font-semibold mb-6 text-brand-800">Calificar equipos</h1>

    <!-- TABS (normalizado) -->
    <div id="main-tabs" class="flex gap-6 mb-6 text-lg">
      <a href="index.html" data-page="index" class="tab-link text-gray-400 hover:text-gray-600">Grupos</a>
      <a href="alumnos.html" data-page="alumnos" class="tab-link text-gray-400 hover:text-gray-600">Alumnos</a>
      <a href="unidades.html" data-page="unidades" class="tab-link text-gray-400 hover:text-gray-600">Unidades</a>
      <a href="equipos.html" data-page="equipos" class="tab-link text-gray-400 hover:text-gray-600">Equipos</a>
      <a href="tareas.html" data-page="tareas" class="tab-link text-gray-400 hover:text-gray-600">Tareas</a>
      <a href="Calificar.html" data-page="calificar" class="tab-link text-gray-400 hover:text-gray-600">Calificar</a>
      <a href="reportes.html" data-page="reportes" class="tab-link text-gray-400 hover:text-gray-600">Reportes</a>
    </div>
    <script>
      (function(){
        const path = window.location.pathname.split('/').pop() || 'Calificar.html';
        const page = (path.replace('.html','') || 'index').toLowerCase();
        document.querySelectorAll('#main-tabs .tab-link').forEach(a=>{
          if(a.dataset.page===page){
            a.classList.remove('text-gray-400');
            a.classList.add('font-semibold','text-brand-700','border-b-2','border-brand-700','pb-1');
          }
        });
      })();
    </script>

    <!-- Header / controles -->
    <div class="bg-white rounded-3xl shadow-xl p-6 w-full border border-gray-100 mb-6">
      <div class="flex items-center gap-6">
        <div id="grupo-info" class="font-semibold"></div>
        <select id="select-unidad" class="select select-bordered bg-white w-72"><option disabled selected>Selecciona una unidad</option></select>
        <select id="select-equipo" class="select select-bordered bg-white w-72"><option disabled selected>Selecciona un equipo</option></select>
        <div class="flex-1"></div>
        <button id="btn-refrescar" class="btn btn-ghost">Refrescar</button>
      </div>
    </div>

    <!-- Contenedor de tareas y calificaciones -->
    <div id="contenedor-calificaciones" class="bg-white rounded-3xl shadow-xl p-6 w-full border border-gray-100">
      <p class="text-gray-600">Selecciona unidad y equipo para ver y editar calificaciones.</p>
    </div>
  </main>
</div>

<!-- FontAwesome -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<script>
let selectedGrupo = null;
window.onload = ()=>{
  const params = new URLSearchParams(window.location.search);
  const grupoParam = params.get('grupo');
  if(grupoParam) localStorage.setItem('selectedGrupo', grupoParam);
  selectedGrupo = localStorage.getItem('selectedGrupo') || null;

  // Si no hay grupo seleccionado, mostrar selector dentro de la página (evita redirigir fuera)
  if(!selectedGrupo){
    const gi = document.getElementById('grupo-info');
    gi.innerHTML = `<select id="sel-grupo-local" class="select select-bordered w-64 bg-white"><option disabled selected>Selecciona un grupo</option></select> <button id="btn-guardar-grupo" class="btn btn-sm ml-2">Usar</button>`;
    // cargar grupos
    fetch('/api/grupos').then(r=>r.json()).then(gs=>{
      const sel = document.getElementById('sel-grupo-local');
      gs.forEach(g=> sel.innerHTML += `<option value="${g.id_grupo}">${g.numero} - ${g.materia}</option>`);
      document.getElementById('btn-guardar-grupo').onclick = ()=>{
        const v = sel.value; if(!v) return alert('Selecciona un grupo');
        localStorage.setItem('selectedGrupo', v); selectedGrupo = v; window.location.reload();
      };
    }).catch(err=>{ console.error(err); gi.innerHTML = '<span class="text-red-500">Error cargando grupos</span>'; });
  } else {
    // mostrar info del grupo
    fetch(`/api/grupos/${selectedGrupo}`).then(r=>r.json()).then(g=>{
      document.getElementById('grupo-info').innerHTML = `${g.numero} - ${g.materia} <button class="btn btn-sm btn-ghost" id="btn-cambiar-grupo">Cambiar</button>`;
      document.getElementById('btn-cambiar-grupo').onclick = ()=>{ localStorage.removeItem('selectedGrupo'); window.location.href='index.html'; };
    });

    // cargar unidades
    fetch(`/api/unidades/${selectedGrupo}`).then(r=>r.json()).then(unis=>{
      const su = document.getElementById('select-unidad'); su.innerHTML = '<option disabled selected>Selecciona una unidad</option>';
      unis.forEach(u=> su.innerHTML += `<option value="${u.id_unidad}">Unidad ${u.numero_unidad}</option>`);
    });
  }

  document.getElementById('select-unidad').addEventListener('change', ()=>{
    const id_unidad = document.getElementById('select-unidad').value;
    cargarEquipos(id_unidad);
    document.getElementById('contenedor-calificaciones').innerHTML = '<p class="text-gray-600">Selecciona un equipo para ver las tareas.</p>';
  });

  document.getElementById('select-equipo').addEventListener('change', ()=>{
    const id_unidad = document.getElementById('select-unidad').value;
    const id_equipo = document.getElementById('select-equipo').value;
    if(id_unidad && id_equipo) cargarTareasYCals(id_unidad, id_equipo);
  });

  document.getElementById('btn-refrescar').onclick = ()=>{
    const id_unidad = document.getElementById('select-unidad').value;
    const id_equipo = document.getElementById('select-equipo').value;
    if(id_unidad && id_equipo) cargarTareasYCals(id_unidad, id_equipo);
  };
};

function cargarEquipos(id_unidad){
  fetch(`/api/equipos/${id_unidad}`).then(r=>r.json()).then(es=>{
    const sel = document.getElementById('select-equipo'); sel.innerHTML = '<option disabled selected>Selecciona un equipo</option>';
    es.forEach(e=> sel.innerHTML += `<option value="${e.id_equipo}">${e.nombre_equipo}</option>`);
  }).catch(err=>{ console.error(err); alert('Error cargando equipos'); });
}

function cargarTareasYCals(id_unidad, id_equipo){
  const cont = document.getElementById('contenedor-calificaciones');
  cont.innerHTML = '<p class="text-gray-600">Cargando tareas y calificaciones...</p>';

  Promise.all([
    fetch(`/api/tareas/${id_unidad}`).then(r=>r.json()),
    fetch(`/api/calificaciones/equipo/${id_equipo}`).then(r=>r.json())
  ]).then(([tareas, califs])=>{
    // map califs por id_tarea
    const calMap = {};
    if(califs && califs.length) califs.forEach(c=> calMap[c.id_tarea] = parseFloat(c.calificacion));

    if(!tareas || tareas.length===0){ cont.innerHTML = '<p class="text-gray-600">No hay tareas en esta unidad.</p>'; return; }

    // construir tabla
    const table = document.createElement('table'); table.className = 'table w-full';
    const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Tarea</th><th>Valor</th><th>Calificación</th><th>Acción</th></tr>';
    const tbody = document.createElement('tbody');
    table.appendChild(thead); table.appendChild(tbody);

    tareas.forEach(t=>{
      const tr = document.createElement('tr');
      const tdName = document.createElement('td'); tdName.textContent = t.nombre_tarea;
      const tdValor = document.createElement('td'); tdValor.textContent = (t.valor ?? 0);
      const tdCal = document.createElement('td');
      const inp = document.createElement('input'); inp.type='number'; inp.min=0; inp.max=100; inp.step='0.1'; inp.className='input input-bordered w-32';
      if(calMap[t.id_tarea]!==undefined) inp.value = calMap[t.id_tarea];
      tdCal.appendChild(inp);
      const tdAcc = document.createElement('td');
      const btn = document.createElement('button'); btn.className='btn btn-sm bg-brand-600 text-white'; btn.textContent='Guardar';
      btn.onclick = ()=>{ guardarCalificacion(id_equipo, t.id_tarea, parseFloat(inp.value), btn); };
      tdAcc.appendChild(btn);

      tr.appendChild(tdName); tr.appendChild(tdValor); tr.appendChild(tdCal); tr.appendChild(tdAcc);
      tbody.appendChild(tr);
    });

    cont.innerHTML = '';
    cont.appendChild(table);
  }).catch(err=>{ console.error(err); cont.innerHTML = '<p class="text-red-500">Error cargando datos</p>'; });
}

function guardarCalificacion(id_equipo, id_tarea, cal, btn){
  if(isNaN(cal)) return alert('Ingresa una calificación válida');
  btn.disabled = true; const prev = btn.innerHTML; btn.innerHTML = 'Guardando...';
  fetch('/api/calificaciones',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id_equipo, id_tarea, calificacion: cal})})
    .then(r=>{
      if(!r.ok) throw new Error('Error en servidor');
      return r.json();
    }).then(()=>{ btn.innerHTML = 'Guardado'; setTimeout(()=>{ btn.disabled=false; btn.innerHTML = prev; },900); })
    .catch(err=>{ console.error(err); alert('Error guardando calificación'); btn.disabled=false; btn.innerHTML = prev; });
}

</script>
</body>
</html>
